---
title: "Ebola simulation: outbreak reconstruction"
author: Thibaut Jombart, Finlay Campbell
categories: ["practicals"]
tags: ["genetics", "simulation", "response", "outbreaker2"]
date: 2017-11-22T14:00:00-00:00
image: img/highres/ebola-blue.jpg
slug: simulated-evd-reconstruction
showonlyimage: true
bibliography: practical-evd.bib
---

	
```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
opts_chunk$set(collapse = TRUE)

install_if_missing <- function(x) {
    if (!require(x, character.only = TRUE)) {
        install.packages(x)
        require(x, character.only = TRUE)
    }
}

deps <- c("xlsx", "incidence", "epicontacts", "EpiEstim", "ggplot2")
lapply(deps, install_if_missing)
```



This practical is the second part of the response to a simulated Ebola Virus
Disease (EVD) outbreak taking place in the city of Ankh, Republic of
Morporkia. While the [**first part**](../simulated-evd-early) focussed on early
assessments of transmissibility, this part explores more methodological options
for estimating transmissibility, and provides an introduction to outbreak
reconstruction using *outbreaker2*.

	       	  
<br>

# An update on the EVD outbreak in Ankh, Republic of Morporkia

After some rather concerning [preliminary results](../simulated-evd-early) on
the new EVD outbreak in the city of Ankh, Republic of Morporkia, Public Health
Morporkia (PHM) has sent you updates of the linelists and contact data. This
time, PHM has also obtained Whole Genome Sequences (WGS) of the Ebola virus
isolated in patients. As before, you are asked to assess the situation and
produce evidence-based recommendations for informing the response.

    

## Required packages

The following packages, available on CRAN, are needed for this practical:

- [`xlsx`](http://www.repidemicsconsortium.org/incidence/) to read `.xlsx` files
- [`ggplot2`](http://ggplot2.org/) for graphics
- [`incidence`](http://www.repidemicsconsortium.org/incidence/) for epicurves
- [`epicontacts`](http://www.repidemicsconsortium.org/epicontacts/) for contact
  data visualisation
- [`EpiEstim`](https://cran.r-project.org/web/packages/EpiEstim/index.html) for
  time-varying reproduction number estimation
  
To install these packages, use `install.packages`, e.g.:
   
```{r install, eval = FALSE}
install.packages("xlsx")
install.packages("ggplot2")
install.packages("incidence")
install.packages("epicontacts")
install.packages("EpiEstim")

```

We will also use several packages currently under development, hosted on
*github*. These include:
   
- [`distcrete`](http://www.repidemicsconsortium.org/distcrete) to obtain
  discrete time delay distributions
- [`epitrix`](http://www.repidemicsconsortium.org/epitrix) for some practical
  tricks
- [`outbreaker2`](http://www.repidemicsconsortium.org/outbreaker2) to
  reconstruct the outbreak
   
   
To install these, you will need a working version of `devtools`, and the
toolchain for package building on your system. On windows, you will likely need
to install [*Rtools*](https://cran.r-project.org/bin/windows/Rtools/).
   
```{r install2, eval = FALSE}
devtools::install_github("reconhub/distcrete")
devtools::install_github("reconhub/epitrix")
devtools::install_github("reconhub/outbreaker2")
```


## The new data
	
The data update includes new linelists and contact lists:

- [**PHM-EVD-linelist-2017-11-25.xlsx**](../../data/PHM-EVD-linelist-2017-11-25.xlsx):
  a linelist containing case information up to the 25th November 2017

- [**PHM-EVD-contacts-2017-11-25.xlsx**](../../data/PHM-EVD-contacts-2017-11-25.xlsx):
  a list of contacts reported between cases up to the 25th November, where
  `from` indicates a potential source of infection, and `to` the recipient of
  the contact.
  

To read into R, download these files and use the function `read.xlsx()` from the
`xlsx` package to import the data. Each import will create a `data.frame`. Call
the first one `linelist`, and the second one `contacts`. For instance, your first
command line could look like:
	
```{r eval = FALSE}
linelist <- xlsx::read.xlsx("PHM-EVD-linelist-2017-11-25.xlsx",
                            sheetIndex = 1, stringsAsFactors = FALSE)
```


Once imported, the data should look like:
          
```{r read_files, echo = -c(1,2)}
linelist <- xlsx::read.xlsx("../../static/data/PHM-EVD-linelist-2017-11-25.xlsx",
                            sheetIndex = 1, stringsAsFactors = FALSE)
contacts <- xlsx::read.xlsx("../../static/data/PHM-EVD-contacts-2017-11-25.xlsx",
                            sheetIndex = 1, stringsAsFactors = FALSE)

## linelist: one line per case
head(linelist)


## contacts: pairs of cases with reported contacts
head(contacts)
```



# Analysis of epidemiological data

## Visualising contact data

After the initial stage of the outbreak, contact tracing has been maintained but
started being sparser, and exposures haven't been reported for all
cases. Despite these limitations, contacts are still a valuable source of
information. Using the function `make_epicontacts` in the `epicontacts` package,
create a new `epicontacts` object called `x`, specifying that contacts are
directed. When plotting the data, use the arguments `node_shape` and `shapes`
(see `?vis_epicontacts`) to distinguish males and females. For a list of
available symbols and corresponding shape code, you can type
`epicontacts::codeawesome`.

The results should look like:
	      
```{r epicontacts, echo = FALSE}
library(epicontacts)
x <- make_epicontacts(linelist,
                      contacts, directed = TRUE)
x
plot(x, node_shape = "sex", shapes = c(male = "male", female = "female"), selector = FALSE)

```

**What can you say about these contacts? How would you interpret the different clusters?**
     

     
## Building epicurves

Using the same approach as in the [first part](../simulated-evd-early) of the
practical, use `incidence` (from the `incidence` package) to compute and plot
epicurves using dates of symptom onset. As the time series is now longer,
compare daily incidence to weekly incidence. 

You should obtain something like:

```{r incidence, echo = FALSE, warning = FALSE, message = FALSE}
library(incidence)
i <- incidence(linelist$onset)
plot(i)
i <- incidence(linelist$onset, interval = 7)
plot(i)
```

As there are no longer time intervals with 'zero' incidence on the weekly
epicurve, which are problematic for log-linear regression, we can try fitting a
model to these data; we do so here, with `i` being the weekly incidence:

```{r fit}
f <- fit(i)
f
plot(i, color = "#c65353", fit = f)
```

How would you interpret this result? What are the limitations of this analysis?



## Estimating transmissibility

Repeating the same analysis as in the [early stage](../simulated-evd-early) of
the outbreak, we can use `get_R` from the `earlyR` package to estimate the
reproduction number:

```{r basic_R}
library(earlyR)

## parameters of the serial interval
mu <- 15.3
sd <- 9.3

daily_i <- incidence(linelist$onset)
simple_R <- get_R(daily_i, si_mean = mu, si_sd =  9.3)
simple_R

## R: likelihood function
plot(simple_R)

## force of infection
plot(simple_R, "lambdas")
abline(v = as.Date("2017-11-25"))
```

What do you make of these results? What is the main limitation of the estimation
of the reproduction number ($R$) in this analysis? What assumption does it make
about the outbreak?



## Estimating time-varying transmissibility

When the assumption that $R$ is constant over time becomes untenable, an
alternative is the estimationg of time-varying transmissibility using the
instantaneous reproduction number $R_t$. This approach, introduced by Cori et
al. [-@Cori2013-fc], is implemented in the package `EpiEstim` (function
`EstimateR`). It esimates $R_t$ for a succession of sliding time windows, using
the same Poisson likelihood described in the [**first
part**](../simulated-evd-early). In the following, we use `EstimateR` to
estimate transmissibility for 1-week sliding time windows:

```{r epiestim}
library(EpiEstim)
library(ggplot2)

days <- seq_along(daily_i$dates)
Rt <- EstimateR(as.vector(daily_i$counts), days, days + 7, method = "ParametricSI",
                   Mean.SI = mu, Std.SI = sd)
Rt <- Rt$R[days,]
head(Rt, 10)

```

`EpiEstim` is not yet integrated with other RECON packages, so adding the
results to existing `incidence` plots takes some customisation using
`ggplot2`. Uses the following commands to add estimates of $R_r$ to the daily
incidence:

```{r epiestimplot}

names(Rt) <- gsub("[(]R[)]", "", names(Rt))
Rt <- cbind.data.frame(as.data.frame(daily_i),
                       Rt)
plot(daily_i) +
    geom_ribbon(data = Rt, fill = "#c65353", alpha = .3,
                aes(ymin = Quantile.0.025, ymax = Quantile.0.975)) +
    geom_line(data = Rt, aes(y = Median), col = "#c65353", alpha = .8) +
    geom_hline(yintercept = 1, linetype = 2) +
    labs(title = "Weekly Rt: median, and 95% CI")

```

**How would you interpret this result? What is the caveat of this representation?**




# Finding who infects whom

## Outbreak reconstruction using onset and contact data

```{r si}
library(epitrix)
library(distcrete)
library(outbreaker2)

mu <- 15.3
sd <- 9.3
si_params <- epitrix::gamma_mucv2shapescale(mu, sd / mu)
si_params
si <- distcrete("gamma", shape = si_params$shape, scale = si_params$scale, interval = 1L, w = 0)
plot(si$d, type = "h", xlim = c(0,50), col = "navy", lwd = 2,
     xlab = "Days after symptoms", ylab = "Probability",
     main = "Serial interval distribution")
```

```{r outbreaker-onset-contacts, cache = TRUE}

ctd <- matrix(match(unlist(contacts), linelist$case_id), ncol = 2)
data <- outbreaker_data(dates = linelist$onset, ctd = ctd, w_dens = si$d(1:100))
config <- create_config(move_kappa = FALSE, move_pi = FALSE, find_import = FALSE)

res_time_ctd <- outbreaker(data = data, config = config)
res_time_ctd
```


See `?plot.outbreaker_chains` for details on available plots.

```{r time_ctd_plots}
plot(res_time_ctd)
plot(res_time_ctd,  type = "alpha", burnin = 1000)
plot(res_time_ctd,  type = "t_inf", burnin = 1000)
```

```{r time_ctd_net}
plot(res_time_ctd,  type = "network", burnin = 1000, min_support = .05)
```

```{r outbreaker-onset-contacts-summary}
smry_time_ctd <- summary(res_time_ctd)
smry_time_ctd
```


# References
